# Map Quest Objectives 버그 수정 PRD

## Overview

- **Status**: In Progress
- **Created**: 2025-12-17
- **Updated**: 2025-12-17
- **Owner**: claude-code
- **Related Agents**: map-feature-specialist

## Problem Statement

Map 탭에서 두 가지 버그가 발생:

1. **Quest Objectives 패널이 비어있음**: "Found 6 active Objectives for GroundZero" 메시지는 표시되지만, 좌측 패널의 퀘스트별 그룹화된 목표 리스트가 표시되지 않음

2. **맵 마커 위치 오류**: Objectives 마커가 맵에 표시되지만 위치가 잘못됨

## Root Cause Analysis

### 현재 상황 요약

PRD에는 이미 수정이 완료된 것으로 기록되어 있으나, **실제로는 문제가 해결되지 않았음**. 재분석 필요.

### 버그 1: Quest Objectives 패널 비어있음

**핵심 문제**: `MapPage.RefreshQuestDrawer()`에서 `_progressService.GetTask(taskObj.TaskNormalizedName)`이 `null`을 반환하여 목표가 패널에 추가되지 않음.

**상세 데이터 흐름 분석**:

```
1. DB에서 로드 (QuestObjectiveDbService):
   QuestObjectives 테이블 + Quests 테이블 JOIN
   ├── QuestObjective.QuestId (DB ID, 예: "5936d90786f7742b1420ba5b")
   ├── QuestObjective.QuestName (영문명, 예: "Debut")
   └── SQL: LEFT JOIN Quests q ON o.QuestId = q.Id

2. 변환 (QuestObjectiveService.ConvertToTaskObjective):
   ├── quest = QuestDbService.Instance.GetQuestById(obj.QuestId)  ← **이미 수정됨**
   ├── taskNormalizedName = quest?.NormalizedName ?? NormalizeQuestName(obj.QuestName)
   └── TaskObjectiveWithLocation.TaskNormalizedName = taskNormalizedName

3. UI에서 사용 (MapPage.RefreshQuestDrawer, line 3189):
   ├── var task = _progressService.GetTask(taskObj.TaskNormalizedName);
   └── if (task != null) { ... } else { /* 패널에 추가되지 않음 */ }
```

**문제 원인**:

1. **QuestObjectiveService.ConvertToTaskObjective()는 이미 수정되어 올바른 NormalizedName을 반환함**
2. **그러나 `_progressService.GetTask()`는 NormalizedName 기반 조회임** (line 182-184)
3. **`GetTask()`는 deprecated 메서드이며, ID 기반 조회를 사용해야 함**

**구조적 문제**:

- `TaskObjectiveWithLocation`에 **QuestId 필드가 없음** - NormalizedName만 저장
- `MapPage.RefreshQuestDrawer()`가 **NormalizedName으로만 조회** 시도
- **ID 기반 조회(`GetTaskById`)를 사용할 수 없는 구조**

**제약사항 위반**:

CLAUDE.md에서 명시된 중요한 제약사항:
> **Quest의 NormalizedName은 데이터 마이그레이션에서만 사용해야 함**
> **DB상의 ID가 기준이 되어야 함** (QuestId, ObjectiveId 등)

현재 코드는 이 제약사항을 위반하고 있음.

### 버그 2: 맵 마커 위치 오류

**원인**: 좌표계 혼동

- DB의 LocationPoint: `X`, `Y` (높이), `Z` (수평면)
- ConvertToTaskObjective에서 변환:
  - `X = firstPoint.X`
  - `Y = firstPoint.Z` (수평면)
  - `Z = firstPoint.Y` (높이)
- QuestObjectiveLocation: `X`, `Y` (수평면), `Z` (높이)

**현재 코드** (MapPage.xaml.cs:1596):
```csharp
var (screenX, screenY) = config.GameToScreen(location.X, location.Z ?? 0);
// location.Z는 높이! 수평면 좌표인 location.Y를 사용해야 함
```

**수정**:
```csharp
var (screenX, screenY) = config.GameToScreen(location.X, location.Y);
```

## 재분석된 문제점 코드

### 문제 1: TaskObjectiveWithLocation 모델 (Models/Map/QuestObjectiveLocation.cs)

```csharp
public sealed class TaskObjectiveWithLocation
{
    public string ObjectiveId { get; set; } = string.Empty;
    // ... other fields ...
    public string TaskNormalizedName { get; set; } = string.Empty;  // ← NormalizedName만 있음
    // ❌ 문제: QuestId 필드가 없음!
}
```

### 문제 2: MapPage.RefreshQuestDrawer() (Pages/Map/MapPage.xaml.cs:3189)

```csharp
// Line 3185
var allTaskObjectives = _objectiveService.GetObjectivesForTask(obj.TaskNormalizedName);
foreach (var taskObj in allTaskObjectives)
{
    // Line 3189 - ❌ NormalizedName으로 조회 (deprecated 메서드)
    var task = _progressService.GetTask(taskObj.TaskNormalizedName);
    if (task != null)  // ← 여기서 null이 반환되면 패널에 추가되지 않음
    {
        var status = _progressService.GetStatus(task);
        if (status == QuestStatus.Active)
        {
            // 목표 추가...
        }
    }
}
```

**왜 null이 반환되는가?**
- `GetTask()`는 `_tasksByNormalizedName` 딕셔너리에서 조회
- 키가 정확히 일치해야 함
- 약간의 불일치라도 있으면 null 반환

**올바른 해결책**:
```csharp
// ✅ ID 기반 조회 사용
var task = _progressService.GetTaskById(taskObj.QuestId);
```

### 문제 3: 좌표 변환 (확인 완료 - 이미 수정됨)

**현재 코드 (MapPage.xaml.cs:1596)**:
```csharp
// ✅ 올바른 좌표 사용 중
var (screenX, screenY) = config.GameToScreen(location.X, location.Y);
```

**확인 결과**: 좌표 변환은 이미 올바르게 수정되어 있음. `location.Y` (수평면 좌표)를 사용 중.

**따라서 버그 2는 실제로 수정되었으며, 버그 1만 해결하면 됨.**

### 버그 3: 맵 이름 형식 불일치 (추가 발견)

**증상**: Quest Objectives 패널에서 `filteredViewModels.Count: 0`으로 표시됨
- `viewModels.Count: 6` (데이터 로드됨)
- `_drawerCurrentMapOnly: True` (필터 활성화)
- `IsOnCurrentMap: False` (맵 이름 비교 실패)

**근본 원인**: 데이터 소스별 맵 이름 형식이 다름

| 데이터 소스 | 맵 이름 형식 | 예시 |
|------------|-------------|------|
| map_configs.json `key` | PascalCase, 공백 없음 | "GroundZero" |
| map_configs.json `displayName` | 일반 형식 | "Ground Zero" |
| tarkov_data.db QuestObjectives.MapName | 일반 형식 | "Ground Zero" |

**데이터 흐름**:
```
1. UI ComboBox Tag: map_configs.json의 key 사용 → "GroundZero"
2. _currentMapKey = "GroundZero"
3. QuestObjective.MapName = "Ground Zero" (DB에서 로드)
4. IsOnCurrentMap 비교: "GroundZero" vs "Ground Zero" → 불일치!
```

**alias 매칭 실패 원인**:
- `_aliasToKey`는 `StringComparer.OrdinalIgnoreCase` 사용 (대소문자 무시)
- 하지만 **공백은 무시하지 않음**
- aliases에 "groundzero", "ground-zero"는 있지만 "Ground Zero" (공백 포함)는 없었음

**해결책**:
1. `map_configs.json`의 GroundZero aliases에 "Ground Zero" 추가
2. `ResolveMapKey()` 메서드 추가 (IMapCoordinateTransformer, MapCoordinateTransformer, MapTrackerService)
3. `MatchesMapKey()` 헬퍼 함수로 공백/하이픈 무시 비교 (임시 해결책)

## Goals

- [x] Goal 1: Quest Objectives 패널에 퀘스트별 그룹화된 목표 표시 (해결 완료)
- [x] Goal 2: 맵 마커가 올바른 위치에 표시 (이미 수정됨)
- [x] Goal 3: 맵 이름 형식 불일치 해결 (map_configs.json 수정, ResolveMapKey 추가)

## Non-Goals (Scope Out)

- 새로운 기능 추가
- UI 디자인 변경
- 다른 맵 관련 버그 수정

## Implementation Plan

### Phase 1: 데이터 모델 수정 (ID 기반 구조로 변경)

**목표**: TaskObjectiveWithLocation에 QuestId 추가하여 ID 기반 조회 가능하게 변경

- [x] Task 1.1: TaskObjectiveWithLocation 모델에 QuestId 필드 추가
  - Files: `Models/Map/QuestObjectiveLocation.cs`
  - Add: `public string QuestId { get; set; } = string.Empty;`
  - Notes: QuestObjective의 QuestId를 저장
  - **Completed**: line 113에 QuestId 필드 추가 완료

- [x] Task 1.2: QuestObjectiveService.ConvertToTaskObjective() 수정
  - Files: `Services/Map/QuestObjectiveService.cs`
  - Change: `result.QuestId = obj.QuestId;` 추가
  - Notes: QuestId를 TaskObjectiveWithLocation에 복사
  - **Completed**: line 176에 QuestId 복사 코드 추가 완료

### Phase 2: MapPage 수정 (ID 기반 조회로 변경)

**목표**: MapPage에서 NormalizedName 대신 QuestId 사용

- [x] Task 2.1: MapPage.RefreshQuestDrawer() 수정
  - Files: `Pages/Map/MapPage.xaml.cs`
  - Change line 3189: `var task = _progressService.GetTask(taskObj.TaskNormalizedName);`
    → `var task = _progressService.GetTaskById(taskObj.QuestId) ?? _progressService.GetTask(taskObj.TaskNormalizedName);`
  - Fallback: `?? _progressService.GetTask(taskObj.TaskNormalizedName);`
  - Notes: ID 기반 조회로 변경하되, NormalizedName을 fallback으로 유지
  - **Completed**: line 3189-3190에 ID 기반 조회 + fallback 코드 적용 완료

- [x] Task 2.2: MapPage에서 다른 NormalizedName 사용 부분 검토
  - Files: `Pages/Map/MapPage.xaml.cs`
  - Check: line 3180, 3182, 3185, 3318
  - Notes: 필요 시 ID 기반으로 변경
  - **Completed**: 검토 결과 해당 라인들은 모두 적절한 용도로 사용 중:
    - line 3180, 3182: 중복 제거를 위한 집합 추적 (변경 불필요)
    - line 3185: 목표 필터링 (변경 불필요)
    - line 3318: UI 그룹화 (변경 불필요)

### Phase 3: 좌표 변환 수정 (이미 완료됨)

**목표**: 올바른 좌표계 사용

- [x] Task 3.1: MapPage.RefreshQuestMarkers() 좌표 재확인
  - Files: `Pages/Map/MapPage.xaml.cs` (line 1596)
  - Verified: `location.Y` 사용 중 (올바름)
  - Notes: 좌표 변환은 이미 수정되어 있음

### Phase 4: 검증

- [x] Task 4.1: 빌드 확인
  - **Completed**: dotnet build 성공 (경과 시간: 00:00:03.24, 경고 0개, 오류 0개)
- [ ] Task 4.2: 수동 테스트 (Ground Zero 맵에서 확인)
  - Quest Objectives 패널에 목표 표시 확인
  - 맵 마커 위치 정확도 확인
  - **Note**: 사용자가 직접 수동 테스트 필요

### Phase 5: 맵 이름 형식 불일치 해결 (추가)

**목표**: DB MapName과 map_configs.json key 간의 형식 차이 해결

- [x] Task 5.1: 근본 원인 분석
  - `_currentMapKey`: map_configs.json의 `key` ("GroundZero")
  - DB QuestObjectives.MapName: "Ground Zero" (공백 포함)
  - aliases에 "Ground Zero" 누락으로 매칭 실패
  - **Completed**: 데이터 흐름 및 원인 분석 완료

- [x] Task 5.2: map_configs.json 수정
  - Files: `Assets/DB/Data/map_configs.json`
  - Change: GroundZero aliases에 "Ground Zero" 추가
  - **Completed**: aliases 업데이트됨

- [x] Task 5.3: ResolveMapKey 메서드 추가
  - Files: `Services/Map/IMapCoordinateTransformer.cs`, `MapCoordinateTransformer.cs`, `MapTrackerService.cs`
  - Add: `ResolveMapKey(string mapNameOrAlias)` 메서드
  - Purpose: DB MapName → config key 변환
  - **Completed**: 인터페이스 및 구현 추가

- [x] Task 5.4: 디버그 로그 제거
  - Files: `Pages/Map/MapPage.xaml.cs`
  - Remove: RefreshQuestDrawer()의 _log.Debug() 호출들
  - Remove: 사용하지 않는 `_log` 필드 및 `using TarkovHelper.Services.Logging;`
  - **Completed**: 클린업 완료

## Technical Decisions

| Decision | Rationale | Date |
|----------|-----------|------|
| TaskObjectiveWithLocation에 QuestId 추가 | ID 기반 조회를 가능하게 하여 CLAUDE.md 제약사항 준수 | 2025-12-17 (재분석) |
| GetTaskById() 사용, GetTask() fallback | 안정성: ID 조회 실패 시 NormalizedName으로 fallback | 2025-12-17 (재분석) |
| location.Y 사용 | QuestObjectiveLocation의 Y가 수평면 좌표, Z는 높이 | 2025-12-17 |

## Dependencies

- [x] QuestDbService가 초기화되어 있어야 함

## Progress Log

| Date | Update | By |
|------|--------|-----|
| 2025-12-17 | PRD 생성, 원인 분석 완료 (초기) | claude-code |
| 2025-12-17 | 버그 1 수정 시도: QuestObjectiveService 수정 (불완전) | claude-code |
| 2025-12-17 | 버그 2 수정 시도: location.Y 사용 (미확인) | claude-code |
| 2025-12-17 | 빌드 성공 확인 (그러나 버그는 여전히 존재) | claude-code |
| 2025-12-17 | **재분석**: NormalizedName 대신 ID 기반 조회 필요 | prd-manager |
| 2025-12-17 | **재분석**: TaskObjectiveWithLocation에 QuestId 필드 추가 필요 | prd-manager |
| 2025-12-17 | Implementation Plan 재작성: 4단계로 세분화 | prd-manager |
| 2025-12-17 | 좌표 변환 이미 수정됨 확인 (Goal 2 완료) | prd-manager |
| 2025-12-17 | 상세 코드 분석 완료 및 PRD 업데이트 완료 | prd-manager |
| 2025-12-17 | **Phase 1 완료**: TaskObjectiveWithLocation에 QuestId 필드 추가 | map-feature-specialist |
| 2025-12-17 | **Phase 1 완료**: QuestObjectiveService에서 QuestId 복사 코드 추가 | map-feature-specialist |
| 2025-12-17 | **Phase 2 완료**: MapPage.RefreshQuestDrawer()에 ID 기반 조회 적용 | map-feature-specialist |
| 2025-12-17 | **Phase 2 완료**: 기타 NormalizedName 사용 검토 완료 (변경 불필요) | map-feature-specialist |
| 2025-12-17 | **Phase 4 완료**: 빌드 성공 (경고 0, 오류 0) | map-feature-specialist |
| 2025-12-17 | **버그 3 발견**: 맵 이름 형식 불일치 (GroundZero vs "Ground Zero") | claude-code |
| 2025-12-17 | **Phase 5 완료**: 근본 원인 분석 - map_configs.json key vs DB MapName 형식 차이 | claude-code |
| 2025-12-17 | **Phase 5 완료**: map_configs.json aliases에 "Ground Zero" 추가 | claude-code |
| 2025-12-17 | **Phase 5 완료**: ResolveMapKey() 메서드 추가 (인터페이스, 구현, 서비스) | claude-code |
| 2025-12-17 | **Phase 5 완료**: 디버그 로그 정리 완료 | claude-code |

## Completion Criteria

- [x] 모든 Goal 달성 확인
  - [x] Goal 1: Quest Objectives 패널 표시 (코드 수정 완료)
  - [x] Goal 2: 맵 마커 위치 (이미 수정됨)
  - [x] Goal 3: 맵 이름 형식 불일치 해결 (map_configs.json + ResolveMapKey)
- [x] Build 성공 (`dotnet build`)
- [ ] 수동 테스트 완료 (사용자가 직접 테스트 필요)
  - [ ] Ground Zero 맵에서 Quest Objectives 패널에 목표 6개 표시 확인
  - [ ] 맵 마커가 올바른 위치에 표시되는지 확인
- [x] 관련 에이전트 Learning Log 업데이트

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| QuestDbService 미초기화 | 중 | null 체크 추가 |
| 다른 맵에서 좌표 문제 | 중 | 여러 맵에서 테스트 |

---

## Archive Info (완료 시 작성)

- **Completed**:
- **Summary**:
- **Actual vs Planned**:
- **Lessons Learned**:
- **Follow-up Items**:

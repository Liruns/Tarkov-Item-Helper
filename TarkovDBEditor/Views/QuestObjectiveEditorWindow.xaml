<Window x:Class="TarkovDBEditor.Views.QuestObjectiveEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:svgc="http://sharpvectors.codeplex.com/svgc/"
        Title="Quest Objective Editor" Height="900" Width="1600"
        Background="#0F0F0F"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header Bar -->
        <Border Grid.Row="0" Background="#1A1A1A" Padding="10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Map Selector -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="Map:" Foreground="#9A8866" VerticalAlignment="Center" Margin="0,0,10,0"/>
                    <ComboBox x:Name="MapSelector" Width="200" Height="28"
                              SelectionChanged="MapSelector_SelectionChanged"/>

                    <TextBlock x:Name="TxtFloorLabel" Text="Floor:" Foreground="#9A8866"
                               VerticalAlignment="Center" Margin="20,0,10,0" Visibility="Collapsed"/>
                    <ComboBox x:Name="FloorSelector" Width="120" Height="28"
                              SelectionChanged="FloorSelector_SelectionChanged"
                              Visibility="Collapsed"/>
                </StackPanel>

                <!-- Progress Info -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center">
                    <TextBlock Text="Progress:" Foreground="#666" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <TextBlock x:Name="ProgressText" Text="0 / 0 (0%)" Foreground="#70A800"
                               FontWeight="Bold" VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Layer Toggles -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <CheckBox x:Name="ChkShowApiMarkers" Content="API Markers" Foreground="#FF9800"
                              IsChecked="True" VerticalAlignment="Center" Margin="0,0,15,0"
                              Checked="LayerToggle_Changed" Unchecked="LayerToggle_Changed"/>
                    <CheckBox x:Name="ChkShowAllObjectives" Content="All Objectives" Foreground="#FFC107"
                              IsChecked="True" VerticalAlignment="Center"
                              Checked="LayerToggle_Changed" Unchecked="LayerToggle_Changed"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="7*" MinWidth="600"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="3*" MinWidth="350"/>
            </Grid.ColumnDefinitions>

            <!-- Left: Map View -->
            <Border Grid.Column="0" Background="#0F0F10" ClipToBounds="True">
                <Grid x:Name="MapViewerGrid"
                      Background="Transparent"
                      MouseLeftButtonDown="MapViewer_MouseLeftButtonDown"
                      MouseLeftButtonUp="MapViewer_MouseLeftButtonUp"
                      MouseRightButtonDown="MapViewer_MouseRightButtonDown"
                      MouseMove="MapViewer_MouseMove"
                      MouseWheel="MapViewer_MouseWheel">

                    <!-- Zoom Control -->
                    <Border HorizontalAlignment="Right" VerticalAlignment="Top"
                            Margin="0,8,24,0" Panel.ZIndex="100"
                            Background="#1A1A1A" CornerRadius="4" Padding="8,4">
                        <StackPanel Orientation="Horizontal">
                            <Button Content="-" Width="28" Height="28" Padding="0"
                                    Background="#333" Foreground="#9A8866" BorderThickness="0"
                                    Click="BtnZoomOut_Click" Margin="0,0,4,0"/>
                            <TextBlock x:Name="ZoomText" Text="100%" Width="50"
                                       Foreground="#9A8866" VerticalAlignment="Center"
                                       TextAlignment="Center"/>
                            <Button Content="+" Width="28" Height="28" Padding="0"
                                    Background="#333" Foreground="#9A8866" BorderThickness="0"
                                    Click="BtnZoomIn_Click" Margin="4,0,4,0"/>
                            <Button Content="Reset" Padding="8,4"
                                    Background="#333" Foreground="#9A8866" BorderThickness="0"
                                    Click="BtnResetView_Click" Margin="4,0,0,0"/>
                        </StackPanel>
                    </Border>

                    <!-- Instructions -->
                    <Border HorizontalAlignment="Left" VerticalAlignment="Top"
                            Margin="8,8,0,0" Panel.ZIndex="100"
                            Background="#1A1A1A" CornerRadius="4" Padding="10,6">
                        <StackPanel>
                            <TextBlock Text="Controls:" Foreground="#9A8866" FontWeight="Bold" Margin="0,0,0,4"/>
                            <TextBlock Text="Select an objective to edit" Foreground="#888" FontSize="11"/>
                            <TextBlock Text="Left-click: Add point" Foreground="#888" FontSize="11"/>
                            <TextBlock Text="Right-click: Remove last" Foreground="#888" FontSize="11"/>
                            <TextBlock Text="Drag: Pan map" Foreground="#888" FontSize="11"/>
                            <TextBlock Text="Scroll: Zoom" Foreground="#888" FontSize="11"/>
                        </StackPanel>
                    </Border>

                    <!-- Map Canvas -->
                    <Canvas x:Name="MapCanvas" Background="#000"
                            HorizontalAlignment="Left" VerticalAlignment="Top">
                        <Canvas.RenderTransform>
                            <TransformGroup>
                                <ScaleTransform x:Name="MapScale" ScaleX="1" ScaleY="1"/>
                                <TranslateTransform x:Name="MapTranslate" X="0" Y="0"/>
                            </TransformGroup>
                        </Canvas.RenderTransform>

                        <!-- Map SVG -->
                        <svgc:SvgViewbox x:Name="MapSvg" Stretch="None"/>

                        <!-- API Markers Layer (Reference) -->
                        <Canvas x:Name="ApiMarkersCanvas"/>

                        <!-- All Objectives Layer -->
                        <Canvas x:Name="ObjectivesCanvas"/>

                        <!-- Currently Editing Points -->
                        <Canvas x:Name="EditingCanvas"/>
                    </Canvas>

                    <!-- Player Position (outside MapCanvas for fixed size) -->
                    <Canvas x:Name="PlayerCanvas" IsHitTestVisible="False"/>
                </Grid>
            </Border>

            <!-- Splitter -->
            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Center"
                          Background="#333" ResizeDirection="Columns"/>

            <!-- Right: Objectives Panel -->
            <Grid Grid.Column="2" Background="#1A1A1A">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Filter Bar -->
                <Border Grid.Row="0" Background="#252525" Padding="10">
                    <StackPanel>
                        <ComboBox x:Name="FilterCombo" Height="28"
                                  SelectionChanged="FilterCombo_SelectionChanged">
                            <ComboBoxItem Content="All" IsSelected="True"/>
                            <ComboBoxItem Content="Pending Approval"/>
                            <ComboBoxItem Content="Approved"/>
                            <ComboBoxItem Content="Has Coordinates"/>
                            <ComboBoxItem Content="No Coordinates"/>
                        </ComboBox>
                        <CheckBox x:Name="ChkHideApproved" Content="Hide Approved"
                                  Foreground="#888" Margin="0,8,0,0"
                                  Checked="ChkHideApproved_Changed" Unchecked="ChkHideApproved_Changed"/>

                        <!-- Near Player Filter -->
                        <Border Background="#333" CornerRadius="3" Padding="8,6" Margin="0,8,0,0">
                            <StackPanel>
                                <CheckBox x:Name="ChkNearPlayer" Content="Near Player Only"
                                          Foreground="#00BCD4"
                                          Checked="ChkNearPlayer_Changed" Unchecked="ChkNearPlayer_Changed"/>
                                <StackPanel Orientation="Horizontal" Margin="20,6,0,0">
                                    <TextBlock Text="Radius:" Foreground="#888" VerticalAlignment="Center"/>
                                    <ComboBox x:Name="RadiusCombo" Width="80" Height="24" Margin="8,0,0,0"
                                              SelectionChanged="RadiusCombo_SelectionChanged">
                                        <ComboBoxItem Content="25m"/>
                                        <ComboBoxItem Content="50m" IsSelected="True"/>
                                        <ComboBoxItem Content="100m"/>
                                        <ComboBoxItem Content="150m"/>
                                        <ComboBoxItem Content="200m"/>
                                    </ComboBox>
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <TextBox x:Name="SearchBox" Height="28" Margin="0,8,0,0"
                                 Background="#333" Foreground="#FFF" BorderBrush="#555"
                                 VerticalContentAlignment="Center" Padding="8,0"
                                 TextChanged="SearchBox_TextChanged"/>
                    </StackPanel>
                </Border>

                <!-- Objectives List -->
                <ListBox x:Name="ObjectivesList" Grid.Row="1"
                         Background="Transparent" BorderThickness="0"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         SelectionChanged="ObjectivesList_SelectionChanged">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="Border" Background="Transparent"
                                                BorderThickness="0,0,0,1" BorderBrush="#333"
                                                Padding="10,8">
                                            <ContentPresenter/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="Border" Property="Background" Value="#2A2A2A"/>
                                                <Setter TargetName="Border" Property="BorderBrush" Value="#70A800"/>
                                                <Setter TargetName="Border" Property="BorderThickness" Value="3,0,0,1"/>
                                            </Trigger>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Border" Property="Background" Value="#222"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Approval Checkbox -->
                                <CheckBox Grid.Column="0" IsChecked="{Binding IsApproved, Mode=OneWay}"
                                          VerticalAlignment="Top" Margin="0,2,10,0"
                                          Checked="ApprovalCheckbox_Changed" Unchecked="ApprovalCheckbox_Changed"/>

                                <!-- Content -->
                                <StackPanel Grid.Column="1">
                                    <!-- Quest Name -->
                                    <TextBlock Text="{Binding QuestName}" Foreground="#9A8866"
                                               FontSize="11" TextTrimming="CharacterEllipsis"/>

                                    <!-- Badges Row -->
                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                        <!-- Type Badge -->
                                        <Border CornerRadius="3" Padding="6,2" Margin="0,0,6,0" Background="#757575">
                                            <TextBlock Text="{Binding ObjectiveType}" Foreground="White" FontSize="10"/>
                                        </Border>
                                        <!-- FIR Badge -->
                                        <Border CornerRadius="3" Padding="6,2" Background="#E65100"
                                                Visibility="{Binding RequiresFIR, Converter={StaticResource BoolToVisibility}}">
                                            <TextBlock Text="FIR" Foreground="White" FontSize="10"/>
                                        </Border>
                                    </StackPanel>

                                    <!-- Description -->
                                    <TextBlock Text="{Binding Description}" Foreground="#CCC"
                                               TextWrapping="Wrap" Margin="0,4,0,0" FontSize="12"
                                               MaxHeight="40" TextTrimming="CharacterEllipsis"/>

                                    <!-- Coordinates Info -->
                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                        <TextBlock Foreground="#70A800" FontSize="10"
                                                   Visibility="{Binding HasCoordinates, Converter={StaticResource BoolToVisibility}}">
                                            <Run Text="Area: "/><Run Text="{Binding LocationPoints.Count, Mode=OneWay}"/><Run Text=" pts"/>
                                        </TextBlock>
                                        <TextBlock Foreground="#FF5722" FontSize="10" Margin="10,0,0,0"
                                                   Visibility="{Binding HasOptionalPoints, Converter={StaticResource BoolToVisibility}}">
                                            <Run Text="OR: "/><Run Text="{Binding OptionalPoints.Count, Mode=OneWay}"/><Run Text=" pts"/>
                                        </TextBlock>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <!-- Detail Panel -->
                <Border Grid.Row="2" Background="#252525" Padding="10" x:Name="DetailPanel">
                    <StackPanel>
                        <!-- Selected Quest Info -->
                        <StackPanel x:Name="SelectedInfoPanel" Visibility="Collapsed">
                            <!-- Quest Name with Wiki Link -->
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock x:Name="SelectedQuestName" Grid.Column="0"
                                           Foreground="#9A8866" FontWeight="Bold" FontSize="13"
                                           TextTrimming="CharacterEllipsis" VerticalAlignment="Center"/>
                                <Button x:Name="BtnOpenWiki" Grid.Column="1" Content="Wiki"
                                        Click="OpenWiki_Click"
                                        Background="#2196F3" Foreground="White" BorderThickness="0"
                                        Padding="10,4" FontSize="11"/>
                            </Grid>

                            <!-- Edit Mode Toggle -->
                            <TextBlock Text="Edit Mode:" Foreground="#666" Margin="0,0,0,8"/>
                            <Border CornerRadius="4" Background="#333">
                                <StackPanel Orientation="Horizontal">
                                    <Button x:Name="BtnAreaMode" Content="Area Points" Padding="15,8"
                                            Background="#70A800" Foreground="White" BorderThickness="0"
                                            Click="EditModeToggle_Click" Tag="Area"/>
                                    <Button x:Name="BtnOrMode" Content="OR Locations" Padding="15,8"
                                            Background="#444" Foreground="#888" BorderThickness="0"
                                            Click="EditModeToggle_Click" Tag="OR"/>
                                </StackPanel>
                            </Border>

                            <!-- Points Info -->
                            <Grid Margin="0,10,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Area Points" Foreground="#70A800" FontWeight="Bold"/>
                                    <TextBlock x:Name="AreaPointsCount" Text="0 points" Foreground="#888"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="OR Locations" Foreground="#FF5722" FontWeight="Bold"/>
                                    <TextBlock x:Name="OrPointsCount" Text="0 points" Foreground="#888"/>
                                </StackPanel>
                            </Grid>

                            <!-- Action Buttons -->
                            <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                                <Button Content="Clear All" Click="ClearPoints_Click"
                                        Background="#C62828" Foreground="White" BorderThickness="0"
                                        Padding="15,8" Margin="0,0,10,0"/>
                                <Button Content="Save Points" Click="SavePoints_Click"
                                        Background="#2196F3" Foreground="White" BorderThickness="0"
                                        Padding="15,8" Margin="0,0,10,0"/>
                                <Button x:Name="BtnApprove" Content="Approve" Click="Approve_Click"
                                        Background="#70A800" Foreground="White" BorderThickness="0"
                                        Padding="15,8"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- No Selection Message -->
                        <TextBlock x:Name="NoSelectionText" Text="Select an objective to edit"
                                   Foreground="#666" HorizontalAlignment="Center" Margin="0,20"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="2" Background="#1A1A1A" Padding="10,5">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="Game Coords:" Foreground="#666" Margin="0,0,5,0"/>
                    <TextBlock x:Name="GameCoordsText" Text="X: -, Z: -" Foreground="#9A8866" Margin="0,0,20,0"/>
                    <TextBlock Text="Screen Coords:" Foreground="#666" Margin="0,0,5,0"/>
                    <TextBlock x:Name="ScreenCoordsText" Text="X: -, Y: -" Foreground="#70A800"/>
                </StackPanel>

                <!-- Player Tracking -->
                <Border Grid.Column="1" CornerRadius="3" Padding="8,2" Margin="10,0"
                        Background="#333" BorderBrush="#555" BorderThickness="1">
                    <StackPanel Orientation="Horizontal">
                        <Ellipse x:Name="WatcherIndicator" Width="8" Height="8" Fill="#666" Margin="0,0,6,0"/>
                        <TextBlock x:Name="PlayerPositionText" Text="Player: --" Foreground="#00BCD4"/>
                        <Button x:Name="WatcherToggleButton" Content="Start" Padding="6,1" Margin="10,0,0,0"
                                Background="#444" Foreground="#CCC" BorderThickness="0" FontSize="10"
                                Click="WatcherToggleButton_Click"/>
                    </StackPanel>
                </Border>

                <TextBlock Grid.Column="2" x:Name="StatusText" Text="Select a map to begin" Foreground="#666"/>
            </Grid>
        </Border>
    </Grid>
</Window>

<Window x:Class="TarkovDBEditor.Views.MapTransferWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Map Transfer - Import Markers from Tarkov Market" Height="900" Width="1400"
        Background="#1E1E1E"
        WindowStartupLocation="CenterOwner">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Top Controls -->
        <Border Grid.Row="0" Background="#2D2D30" Padding="10">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Row 1: Map/Floor Selection -->
                <StackPanel Grid.Row="0" Orientation="Horizontal">
                    <!-- Map Selector -->
                    <TextBlock Text="Map:" Foreground="#D4D4D4" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <ComboBox x:Name="MapSelector" Width="200" Height="28" Margin="0,0,20,0"
                              SelectionChanged="MapSelector_SelectionChanged"
                              DisplayMemberPath="DisplayName"/>

                    <!-- Floor Selector -->
                    <TextBlock x:Name="TxtFloorLabel" Text="Floor:" Foreground="#D4D4D4"
                               VerticalAlignment="Center" Margin="0,0,8,0" Visibility="Collapsed"/>
                    <ComboBox x:Name="FloorSelector" Width="150" Height="28" Margin="0,0,20,0"
                              SelectionChanged="FloorSelector_SelectionChanged" Visibility="Collapsed"/>

                    <Separator Width="1" Background="#555" Margin="10,2"/>

                    <!-- Layer Visibility -->
                    <TextBlock Text="표시:" Foreground="#D4D4D4" VerticalAlignment="Center" Margin="10,0,8,0"/>
                    <CheckBox x:Name="ChkShowDbMarkers" Content="DB 마커" Foreground="#4CAF50"
                              IsChecked="True" VerticalAlignment="Center" Margin="0,0,12,0"
                              Checked="LayerVisibility_Changed" Unchecked="LayerVisibility_Changed"
                              ToolTip="DB에 저장된 마커 (녹색)"/>
                    <CheckBox x:Name="ChkShowApiMarkers" Content="API 마커" Foreground="#2196F3"
                              IsChecked="True" VerticalAlignment="Center" Margin="0,0,12,0"
                              Checked="LayerVisibility_Changed" Unchecked="LayerVisibility_Changed"
                              ToolTip="API에서 가져온 마커 (파란색). 클릭하여 선택"/>
                    <CheckBox x:Name="ChkShowMatched" Content="매칭 선" Foreground="#FFC107"
                              IsChecked="True" VerticalAlignment="Center"
                              Checked="LayerVisibility_Changed" Unchecked="LayerVisibility_Changed"
                              ToolTip="DB↔API 매칭된 마커 연결선. 노란선=참조점, 주황선=일반 매칭. 우클릭으로 참조점 토글"/>

                    <Separator Width="1" Background="#555" Margin="10,2"/>

                    <!-- Zoom Controls -->
                    <Button x:Name="BtnZoomOut" Content="-" Width="28" Height="28" Click="BtnZoomOut_Click"
                            Background="#3E3E42" Foreground="White" BorderBrush="#555"/>
                    <TextBlock x:Name="ZoomText" Text="100%" Foreground="#D4D4D4" Width="60"
                               TextAlignment="Center" VerticalAlignment="Center" Margin="4,0"/>
                    <Button x:Name="BtnZoomIn" Content="+" Width="28" Height="28" Click="BtnZoomIn_Click"
                            Background="#3E3E42" Foreground="White" BorderBrush="#555"/>
                    <Button x:Name="BtnResetView" Content="Reset" Width="60" Height="28" Margin="10,0,0,0"
                            Click="BtnResetView_Click" Background="#3E3E42" Foreground="White" BorderBrush="#555"/>
                </StackPanel>

                <!-- Row 2: Action Buttons -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,10,0,0">
                    <Button x:Name="BtnFetchApi" Content="① API 불러오기" Width="120" Height="28"
                            Click="BtnFetchApi_Click" Background="#0078D4" Foreground="White" BorderBrush="#0078D4"
                            Margin="0,0,10,0"
                            ToolTip="Tarkov Market API에서 마커 데이터를 가져옵니다"/>
                    <Button x:Name="BtnAutoMatch" Content="② 자동 보정" Width="100" Height="28"
                            Click="BtnAutoMatch_Click" Background="#FF8C00" Foreground="White" BorderBrush="#FF8C00"
                            Margin="0,0,10,0" IsEnabled="False"
                            ToolTip="DB 마커와 API 마커를 매칭하고 좌표를 자동 보정합니다"/>
                    <Button x:Name="BtnCalcTransform" Content="재계산" Width="70" Height="28"
                            Click="BtnCalcTransform_Click" Background="#3E3E42" Foreground="White" BorderBrush="#555"
                            Margin="0,0,5,0" IsEnabled="False"
                            ToolTip="참조점(노란선)을 기준으로 좌표 변환을 다시 계산합니다. Ctrl+드래그로 DB마커 위치 수정 후 재계산 가능"/>
                    <Button x:Name="BtnApplyTransform" Content="적용" Width="50" Height="28"
                            Click="BtnApplyTransform_Click" Background="#3E3E42" Foreground="White" BorderBrush="#555"
                            Margin="0,0,5,0" IsEnabled="False"
                            ToolTip="계산된 변환을 모든 API 마커에 다시 적용합니다"/>
                    <Button x:Name="BtnResetDbPositions" Content="초기화" Width="60" Height="28"
                            Click="BtnResetDbPositions_Click" Background="#D32F2F" Foreground="White" BorderBrush="#B71C1C"
                            Margin="0,0,10,0" IsEnabled="False"
                            ToolTip="수정한 DB 마커 위치를 원래대로 되돌립니다"/>

                    <Separator Width="1" Background="#555" Margin="10,2"/>

                    <Button x:Name="BtnSelectAll" Content="전체 선택" Width="80" Height="28"
                            Click="BtnSelectAll_Click" Background="#3E3E42" Foreground="White" BorderBrush="#555"
                            Margin="10,0,10,0" IsEnabled="False"
                            ToolTip="필터된 API 마커를 전체 선택/해제합니다. 마커 클릭으로 개별 선택 가능"/>
                    <Button x:Name="BtnImportSelected" Content="③ DB에 저장" Width="100" Height="28"
                            Click="BtnImportSelected_Click" Background="#107C10" Foreground="White" BorderBrush="#107C10"
                            Margin="0,0,10,0" IsEnabled="False"
                            ToolTip="선택된 API 마커를 DB에 저장합니다. Extraction, Spawn 등 매핑 가능한 타입만 저장됩니다"/>

                    <Separator Width="1" Background="#555" Margin="10,2"/>

                    <!-- Category Filter -->
                    <TextBlock Text="카테고리:" Foreground="#D4D4D4" VerticalAlignment="Center" Margin="10,0,8,0"/>
                    <ComboBox x:Name="CategoryFilter" Width="130" Height="28"
                              SelectionChanged="CategoryFilter_SelectionChanged"
                              ToolTip="API 마커를 카테고리별로 필터링합니다">
                        <ComboBoxItem Content="All" IsSelected="True"/>
                        <ComboBoxItem Content="Extractions"/>
                        <ComboBoxItem Content="Spawns"/>
                        <ComboBoxItem Content="Quests"/>
                        <ComboBoxItem Content="Keys"/>
                        <ComboBoxItem Content="Loot"/>
                        <ComboBoxItem Content="Miscellaneous"/>
                    </ComboBox>

                    <Separator Width="1" Background="#555" Margin="10,2"/>

                    <!-- Manual Offset -->
                    <TextBlock Text="수동 오프셋:" Foreground="#D4D4D4" VerticalAlignment="Center" Margin="10,0,8,0"
                               ToolTip="보정된 좌표를 추가로 미세 조정합니다"/>
                    <TextBlock Text="X" Foreground="#888" VerticalAlignment="Center" Margin="0,0,4,0"/>
                    <TextBox x:Name="TxtOffsetX" Width="50" Height="24" Text="0"
                             Background="#3E3E42" Foreground="White" BorderBrush="#555"
                             TextChanged="OffsetChanged" ToolTip="X축 오프셋 (게임 좌표)"/>
                    <TextBlock Text="Z" Foreground="#888" VerticalAlignment="Center" Margin="8,0,4,0"/>
                    <TextBox x:Name="TxtOffsetZ" Width="50" Height="24" Text="0"
                             Background="#3E3E42" Foreground="White" BorderBrush="#555"
                             TextChanged="OffsetChanged" ToolTip="Z축 오프셋 (게임 좌표)"/>
                    <Button Content="오프셋 적용" Width="80" Height="24" Margin="8,0,0,0"
                            Click="BtnApplyOffset_Click" Background="#3E3E42" Foreground="White" BorderBrush="#555"
                            ToolTip="입력한 오프셋을 모든 API 마커에 추가로 적용합니다"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Map Viewer -->
        <Grid Grid.Row="1" x:Name="MapViewerGrid" Background="#1A1A1A"
              ClipToBounds="True"
              MouseLeftButtonDown="MapViewer_MouseLeftButtonDown"
              MouseLeftButtonUp="MapViewer_MouseLeftButtonUp"
              MouseMove="MapViewer_MouseMove"
              MouseWheel="MapViewer_MouseWheel"
              MouseRightButtonDown="MapViewer_MouseRightButtonDown">

            <Canvas x:Name="MapCanvas"
                    RenderTransformOrigin="0,0">
                <Canvas.RenderTransform>
                    <TransformGroup>
                        <ScaleTransform x:Name="MapScale" ScaleX="1" ScaleY="1"/>
                        <TranslateTransform x:Name="MapTranslate" X="0" Y="0"/>
                    </TransformGroup>
                </Canvas.RenderTransform>

                <!-- SVG Map Background -->
                <svgc:SvgViewbox x:Name="MapSvg"
                                 xmlns:svgc="http://sharpvectors.codeplex.com/svgc/"
                                 Stretch="None"
                                 Canvas.Left="0" Canvas.Top="0"/>

                <!-- DB Markers Layer (Green) -->
                <Canvas x:Name="DbMarkersCanvas"/>

                <!-- API Markers Layer (Blue) -->
                <Canvas x:Name="ApiMarkersCanvas"/>

                <!-- Match Lines Layer (Yellow) -->
                <Canvas x:Name="MatchLinesCanvas"/>
            </Canvas>
        </Grid>

        <!-- Info Panel -->
        <Border Grid.Row="2" Background="#252526" Padding="10,6">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Transform Info -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="Transform:" Foreground="#888" Margin="0,0,8,0"/>
                    <TextBlock x:Name="TransformInfoText" Text="Not calculated" Foreground="#D4D4D4"/>
                    <TextBlock Text="  |  Avg Error:" Foreground="#888" Margin="20,0,8,0"/>
                    <TextBlock x:Name="ErrorText" Text="-" Foreground="#D4D4D4"/>
                    <TextBlock Text="  |  Reference Points:" Foreground="#888" Margin="20,0,8,0"/>
                    <TextBlock x:Name="RefPointCountText" Text="0" Foreground="#FFC107" FontWeight="Bold"/>
                </StackPanel>

                <!-- Selection Info -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBlock Text="Selected:" Foreground="#888" Margin="0,0,8,0"/>
                    <TextBlock x:Name="SelectedCountText" Text="0" Foreground="#2196F3" FontWeight="Bold"/>
                    <TextBlock Text=" API markers" Foreground="#888"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border Grid.Row="3" Background="#2D2D30" Padding="10,6">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock x:Name="StatusText" Grid.Column="0" Text="Select a map and click 'Fetch API'"
                           Foreground="#888"/>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="20,0">
                    <TextBlock Text="DB: " Foreground="#4CAF50"/>
                    <TextBlock x:Name="DbMarkerCountText" Text="0" Foreground="#4CAF50" FontWeight="Bold"/>
                    <TextBlock Text="  |  API: " Foreground="#2196F3" Margin="10,0,0,0"/>
                    <TextBlock x:Name="ApiMarkerCountText" Text="0" Foreground="#2196F3" FontWeight="Bold"/>
                    <TextBlock Text="  |  Matched: " Foreground="#FFC107" Margin="10,0,0,0"/>
                    <TextBlock x:Name="MatchedCountText" Text="0" Foreground="#FFC107" FontWeight="Bold"/>
                </StackPanel>

                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <TextBlock Text="Game: " Foreground="#888"/>
                    <TextBlock x:Name="GameCoordsText" Text="X: 0, Z: 0" Foreground="#D4D4D4" Width="150"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
